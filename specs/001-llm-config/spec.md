# Feature Specification: LLM配置管理

**Feature Branch**: `001-llm-config`
**Created**: 2025-12-06
**Status**: Draft
**Input**: User description: "LLM配置管理 - 统一管理多种大语言模型供应商的配置，包括供应商管理、接入点配置、密钥管理、模型管理"

## Clarifications

### Session 2025-12-06

- Q: 当配置多个接入点时，故障转移应采用什么策略？ → A: 轮询负载均衡（在健康接入点间轮流分配）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 供应商配置管理 (Priority: P1)

作为系统管理员，我需要能够添加和管理LLM供应商配置，以便系统能够连接到各种大语言模型服务。

**Why this priority**: 供应商配置是整个LLM配置管理的基础，没有供应商配置，其他功能（接入点、密钥、模型）都无法正常工作。这是最核心的MVP功能。

**Independent Test**: 可以通过创建一个OpenAI供应商配置并验证其保存和查询功能来独立测试。即使没有接入点和密钥，供应商记录本身也有业务价值（为后续配置做准备）。

**Acceptance Scenarios**:

1. **Given** 系统中没有任何供应商配置, **When** 管理员创建一个名为"OpenAI Production"的OpenAI类型供应商, **Then** 系统成功保存供应商信息并返回唯一标识符
2. **Given** 系统中已存在多个供应商配置, **When** 管理员查询供应商列表, **Then** 系统返回所有供应商的基本信息列表
3. **Given** 系统中存在一个供应商配置, **When** 管理员更新该供应商的名称和描述, **Then** 系统成功更新并保留其他关联数据
4. **Given** 系统中存在一个未被使用的供应商配置, **When** 管理员删除该供应商, **Then** 系统执行软删除，标记为已删除状态
5. **Given** 系统中存在一个正在被Agent团队使用的供应商, **When** 管理员尝试删除该供应商, **Then** 系统拒绝删除并提示供应商正在使用中

---

### User Story 2 - 接入点配置管理 (Priority: P1)

作为系统管理员，我需要为每个供应商配置API接入点信息，包括URL地址、超时设置和重试策略，以便系统能够正确调用供应商API。

**Why this priority**: 接入点是连接供应商的必要配置，没有接入点URL，系统无法发送API请求。与供应商配置同等重要。

**Independent Test**: 可以通过为已创建的供应商添加接入点配置，并验证配置的保存和健康检查功能来独立测试。

**Acceptance Scenarios**:

1. **Given** 系统中存在一个OpenAI供应商, **When** 管理员为其创建接入点配置（URL、超时30秒、重试3次）, **Then** 系统成功保存接入点配置
2. **Given** 供应商已有一个接入点配置, **When** 管理员创建第二个接入点（用于故障转移）, **Then** 系统成功保存并支持多接入点
3. **Given** 供应商有多个接入点, **When** 管理员将某个接入点设为默认, **Then** 系统自动取消原默认接入点的默认状态
4. **Given** 接入点配置已创建, **When** 管理员执行健康检查, **Then** 系统测试连通性并返回检查结果（健康/降级/不可用）
5. **Given** 供应商只有一个接入点, **When** 管理员尝试删除该接入点, **Then** 系统拒绝删除并提示至少需要保留一个接入点

---

### User Story 3 - 密钥安全管理 (Priority: P1)

作为系统管理员，我需要能够安全地存储和管理API密钥，密钥必须加密存储且在查询时脱敏显示，以保护敏感信息安全。

**Why this priority**: 密钥是调用LLM API的认证凭据，安全性至关重要。没有密钥，API调用无法通过认证。

**Independent Test**: 可以通过添加密钥、验证加密存储、确认脱敏显示来独立测试。安全测试可验证密钥无法被明文读取。

**Acceptance Scenarios**:

1. **Given** 系统中存在一个供应商配置, **When** 管理员添加API密钥, **Then** 系统使用AES-256加密后存储密钥
2. **Given** 供应商已配置密钥, **When** 管理员查询密钥列表, **Then** 系统返回脱敏后的密钥（仅显示末4位）
3. **Given** 密钥已配置, **When** 管理员执行密钥验证, **Then** 系统调用供应商API验证密钥有效性并返回结果
4. **Given** 密钥已过期或配额用尽, **When** 管理员更新（轮换）密钥, **Then** 系统使用新密钥替换旧密钥，旧密钥立即失效
5. **Given** 供应商只有一个有效密钥, **When** 管理员尝试删除该密钥, **Then** 系统拒绝删除并提示至少需要保留一个有效密钥

---

### User Story 4 - 模型配置管理 (Priority: P2)

作为系统管理员，我需要管理各供应商提供的可用模型列表，包括模型能力、定价和上下文窗口信息，以便Agent团队能够选择合适的模型。

**Why this priority**: 模型配置是Agent选择LLM的依据，但可以在供应商、接入点、密钥配置完成后再进行配置，因此优先级稍低。

**Independent Test**: 可以通过同步供应商模型列表、查询特定能力的模型来独立测试。模型信息对Agent选型有直接价值。

**Acceptance Scenarios**:

1. **Given** 供应商已配置有效的接入点和密钥, **When** 管理员触发模型同步, **Then** 系统从供应商API获取可用模型列表并保存
2. **Given** 模型已同步, **When** 管理员查询支持function_calling能力的模型, **Then** 系统返回所有具备该能力的模型列表
3. **Given** 模型已同步, **When** 管理员更新某个模型的定价信息, **Then** 系统成功更新模型配置
4. **Given** 供应商下线了某个模型, **When** 管理员重新同步模型列表, **Then** 系统将该模型标记为deprecated而非删除
5. **Given** 系统中有多个供应商的模型, **When** 管理员按能力标签搜索模型, **Then** 系统返回跨供应商的符合条件的模型列表

---

### Edge Cases

- 当供应商API暂时不可用时，系统应返回友好的错误信息，不影响其他供应商的正常使用
- 当密钥配额即将耗尽时，系统应在执行验证时提示配额警告
- 当加密密钥丢失或损坏时，系统应有明确的错误提示，管理员需要重新配置密钥
- 当同时配置多个接入点时，系统采用轮询负载均衡策略（仅在健康接入点间轮流分配请求）
- 当供应商类型不支持自动模型同步时，系统应允许手动添加模型配置

## Requirements *(mandatory)*

### Functional Requirements

**供应商管理**:
- **FR-001**: 系统必须支持创建供应商配置，包含名称、类型和描述信息
- **FR-002**: 系统必须支持以下供应商类型：OpenAI、Anthropic、AWS Bedrock、Azure OpenAI、阿里云通义千问、百度文心一言、Ollama、vLLM
- **FR-003**: 系统必须支持查询、更新、删除（软删除）供应商配置
- **FR-004**: 系统必须支持启用/禁用供应商状态切换
- **FR-005**: 系统必须在删除供应商前检查是否有正在使用的Agent团队

**接入点管理**:
- **FR-006**: 系统必须支持为每个供应商配置多个接入点
- **FR-007**: 系统必须支持配置接入点的URL、API版本、区域、连接超时、读取超时、重试次数
- **FR-008**: 系统必须支持设置默认接入点，每个供应商只能有一个默认接入点
- **FR-009**: 系统必须支持接入点健康检查，返回健康状态和延迟信息
- **FR-010**: 系统必须确保每个供应商至少有一个接入点
- **FR-010a**: 系统必须支持多接入点轮询负载均衡，仅在健康接入点间轮流分配请求

**密钥管理**:
- **FR-011**: 系统必须使用AES-256算法加密存储所有API密钥
- **FR-012**: 系统必须在返回密钥信息时进行脱敏处理（仅显示末4位）
- **FR-013**: 系统必须支持密钥的添加、更新（轮换）和删除
- **FR-014**: 系统必须支持密钥有效性验证，通过调用供应商API测试
- **FR-015**: 系统必须支持配置密钥的过期时间和配额限制
- **FR-016**: 系统必须确保每个供应商至少有一个有效密钥

**模型管理**:
- **FR-017**: 系统必须支持从供应商API自动同步可用模型列表
- **FR-018**: 系统必须支持手动添加和更新模型配置
- **FR-019**: 系统必须记录模型的能力标签（如function_calling、vision、streaming等）
- **FR-020**: 系统必须记录模型的上下文窗口大小和最大输出token数
- **FR-021**: 系统必须支持按供应商、类型、能力、状态筛选模型
- **FR-022**: 系统必须支持模型状态管理（可用、维护中、已废弃）

### Key Entities

- **Provider（供应商）**: 表示一个LLM服务供应商，包含名称、类型（枚举）、描述、启用状态、创建/更新时间
- **Endpoint（接入点）**: 表示供应商的API接入配置，属于某个Provider，包含URL、版本、区域、超时配置、重试策略、是否默认
- **Credential（密钥）**: 表示API访问凭据，属于某个Provider，包含加密后的API Key、Secret Key、别名、过期时间、配额限制、启用状态
- **Model（模型）**: 表示供应商提供的LLM模型，属于某个Provider，包含模型ID、名称、类型、能力标签、上下文窗口、定价信息、状态

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理员可以在2分钟内完成一个新供应商的完整配置（供应商+接入点+密钥）
- **SC-002**: 密钥加密存储后，任何数据库直接查询都无法获取明文密钥
- **SC-003**: 接入点健康检查在10秒内返回结果
- **SC-004**: 模型同步操作在30秒内完成（针对单个供应商）
- **SC-005**: 系统支持同时管理至少10个供应商、每个供应商至少5个接入点、10个密钥、100个模型
- **SC-006**: 配置变更（增删改）操作的响应时间不超过1秒
- **SC-007**: 密钥验证操作准确返回有效/无效状态，准确率达到100%

## Assumptions

- 假设所有供应商API遵循RESTful规范或有官方SDK支持
- 假设AES-256加密密钥由系统配置安全管理，不在本功能范围内详细定义
- 假设模型能力标签采用业界通用定义（function_calling、vision、streaming、json_mode等）
- 假设密钥配额信息可通过供应商API获取，部分供应商可能不支持
- 假设本地部署的供应商（Ollama、vLLM）不需要API密钥配置
